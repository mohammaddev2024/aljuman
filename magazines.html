<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>آرشیو مجلات - مجله فرهنگی نور</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <a href="index.html"><img src="https://images.pexels.com/photos/159711/books-bookstore-book-reading-159711.jpeg?auto=compress&cs=tinysrgb&w=60" alt="لوگو" class="logo-img"></a>
                    <div class="logo-text">
                        <h1>آرشیو مجلات</h1>
                        <span class="tagline">دانلود نسخه‌های PDF مجله فرهنگی نور</span>
                    </div>
                </div>
                <nav class="nav desktop-nav">
                    <ul class="nav-list">
                        <li><a href="index.html" class="nav-link">خانه</a></li>
                        <li><a href="magazines.html" class="nav-link active">آرشیو مجله</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <section class="content-section active">
                <div class="section-header">
                    <h2>آرشیو مجلات</h2>
                    <p>لیست شماره‌های منتشر شده — روی دانلود کلیک کنید تا PDF را باز یا ذخیره کنید</p>
                </div>

                <div class="magazine-grid" id="magazinesGrid">
                    <!-- magazine cards will be rendered here -->
                </div>

                <div class="empty-state" id="magazineEmptyState" style="display:none; text-align:center; padding:40px;">
                    <i class="fas fa-book-open" style="font-size:3rem; opacity:0.6;"></i>
                    <h3 style="margin-top:1rem;">هنوز شماره‌ای از مجله منتشر نشده</h3>
                    <p>به زودی اولین شماره منتشر خواهد شد</p>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; ۱۴۰۳ مجله فرهنگی نور</p>
            </div>
        </div>
    </footer>

    <script src="js/data.js"></script>
    <script>
        // Render magazines helper that can be called multiple times
        function renderMagazinesList(magazines) {
            const magazinesGrid = document.getElementById('magazinesGrid');
            const emptyState = document.getElementById('magazineEmptyState');
            const defaultCover = 'https://images.pexels.com/photos/159711/books-bookstore-book-reading-159711.jpeg?auto=compress&cs=tinysrgb&w=400';

            if (!magazines || magazines.length === 0) {
                if (magazinesGrid) magazinesGrid.innerHTML = '';
                if (emptyState) emptyState.style.display = 'block';
                return;
            }

            if (emptyState) emptyState.style.display = 'none';
            magazinesGrid.innerHTML = '';

            magazines.forEach(magazine => {
                const card = document.createElement('div');
                card.className = 'magazine-card';

                const monthName = (window.dataManager && window.dataManager.getMonthName) ? window.dataManager.getMonthName(magazine.month || magazine.month_number) : '';
                const coverImage = magazine.coverImage || magazine.cover_image || (magazine.cover || '') || defaultCover;
                const pdfUrl = magazine.pdfUrl || magazine.pdf_url || magazine.pdf || '';

                // sanitize pdfUrl: allow http(s) or root-relative or data: otherwise treat empty
                const validPdf = (typeof pdfUrl === 'string' && pdfUrl.trim().length > 0 && (pdfUrl.startsWith('http') || pdfUrl.startsWith('/') || pdfUrl.startsWith('data:')));

                // create elements to avoid innerHTML injection issues
                const img = document.createElement('img');
                img.className = 'magazine-cover';
                img.loading = 'lazy';
                img.alt = magazine.title || 'مجله';
                img.src = coverImage || defaultCover;
                img.onerror = function() { this.onerror = null; this.src = defaultCover; };

                const info = document.createElement('div');
                info.className = 'magazine-info';

                const title = document.createElement('h3');
                title.className = 'magazine-title';
                title.textContent = magazine.title || 'بدون عنوان';

                const date = document.createElement('p');
                date.className = 'magazine-date';
                date.textContent = `${monthName} ${magazine.year || ''}`.trim();

                const desc = document.createElement('p');
                desc.className = 'magazine-description';
                desc.textContent = magazine.description || '';

                const actions = document.createElement('div');
                actions.className = 'magazine-actions';

                if (validPdf) {
                    const a = document.createElement('a');
                    a.className = 'download-btn';
                    a.href = pdfUrl;
                    a.target = '_blank';
                    a.rel = 'noopener noreferrer';
                    a.innerHTML = '<i class="fas fa-download"></i> دانلود PDF';
                    actions.appendChild(a);
                } else {
                    const btn = document.createElement('button');
                    btn.className = 'download-btn';
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'default';
                    btn.textContent = 'PDF موجود نیست';
                    actions.appendChild(btn);
                }

                info.appendChild(title);
                info.appendChild(date);
                info.appendChild(desc);
                info.appendChild(actions);

                card.appendChild(img);
                card.appendChild(info);

                magazinesGrid.appendChild(card);
            });
        }

        // Initial load: try server, then fallback to local
        async function initialLoadMagazines() {
            let magazines = [];
            try {
                const res = await fetch('api/magazines.php');
                if (res.ok) {
                    const json = await res.json().catch(() => null);
                    if (Array.isArray(json) && json.length > 0) magazines = json;
                }
            } catch (e) {
                console.warn('خطا در دریافت لیست مجلات از سرور:', e);
            }

            // Fallback to local dataManager if server returned nothing
            if ((!magazines || magazines.length === 0) && window.dataManager) {
                magazines = window.dataManager.getAllMagazines();
            }

            renderMagazinesList(magazines);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initialLoadMagazines();

            // React to dataManager events so page updates when async sync completes
            try {
                window.addEventListener('dataManager:initialized', (e) => {
                    const mags = (e && e.detail && e.detail.magazines) ? e.detail.magazines : (window.dataManager ? window.dataManager.getAllMagazines() : []);
                    renderMagazinesList(mags);
                });

                window.addEventListener('dataManager:magazinesUpdated', (e) => {
                    const mags = (window.dataManager && window.dataManager.getAllMagazines) ? window.dataManager.getAllMagazines() : (Array.isArray(e && e.detail) ? e.detail : []);
                    renderMagazinesList(mags);
                });
            } catch (err) { /* ignore */ }
        });
    </script>

    <script>
        // Debug panel for diagnostics (only visible when something fails)
        (function(){
            function addDebugPanel() {
                const panel = document.createElement('div');
                panel.id = 'debugPanel';
                panel.style.cssText = 'position:fixed;left:10px;bottom:10px;max-width:360px;max-height:40vh;overflow:auto;background:rgba(0,0,0,0.85);color:#fff;padding:12px;border-radius:8px;z-index:99999;font-size:13px;line-height:1.4;box-shadow:0 6px 24px rgba(0,0,0,0.4);';
                panel.innerHTML = '<strong>Debug: magazines</strong><div id="debugContent" style="margin-top:8px;font-size:12px;color:#ddd"></div>';
                document.body.appendChild(panel);
            }

            function debug(msg, obj) {
                try { console.log('[magazines-debug]', msg, obj || ''); } catch(e){}
                const el = document.getElementById('debugContent');
                if (el) {
                    const row = document.createElement('div');
                    row.textContent = msg + (obj ? (" => " + (typeof obj === 'string' ? obj : JSON.stringify(obj))) : '');
                    el.appendChild(row);
                }
            }

            async function runDiagnostics() {
                addDebugPanel();

                // Show cookie and PHP session presence
                debug('document.cookie', document.cookie || '(no cookies)');

                // LocalStorage key content
                try {
                    const ls = localStorage.getItem('persianMagazineMagazines');
                    debug('localStorage persianMagazineMagazines present', ls ? 'yes' : 'no');
                    if (ls) {
                        try { debug('localStorage length', JSON.parse(ls).length); } catch(e){ debug('localStorage parse error', e.message); }
                    }
                } catch(e) { debug('localStorage read error', e.message); }

                // dataManager state if available
                if (window.dataManager) {
                    try {
                        const dm = window.dataManager;
                        debug('dataManager.magazines.length', Array.isArray(dm.magazines) ? dm.magazines.length : String(dm.magazines));
                        debug('dataManager.getAllMagazines() length', Array.isArray(dm.getAllMagazines()) ? dm.getAllMagazines().length : 'n/a');
                    } catch(e) { debug('dataManager read error', e.message); }
                } else {
                    debug('dataManager', 'not initialized yet');
                }

                // Try server fetch without credentials and with credentials
                async function tryFetch(opts) {
                    try {
                        const res = await fetch('api/magazines.php', opts);
                        const text = await res.text().catch(()=>null);
                        debug('fetch (' + (opts && opts.credentials ? opts.credentials : 'no-credentials') + ') status', res.status + (res.ok ? ' OK' : ''));
                        debug('fetch response body', text ? (text.length > 1000 ? text.slice(0,1000) + '... (truncated)' : text) : '(no body)');
                    } catch (e) {
                        debug('fetch error (' + (opts && opts.credentials ? opts.credentials : 'no-credentials') + ')', e.message);
                    }
                }

                await tryFetch({});
                await tryFetch({ credentials: 'same-origin' });

                // If dataManager exists but magazines are empty, show hint
                if (window.dataManager && Array.isArray(window.dataManager.magazines) && window.dataManager.magazines.length === 0) {
                    debug('hint', 'dataManager.magazines is empty. If you added magazines in admin, ensure server-side POST succeeded and returned id. Check Network tab for POST to api/magazines.php.');
                }

                debug('done', 'Inspect Network/Console for more details.');
            }

            document.addEventListener('DOMContentLoaded', () => {
                // run diagnostics after a short delay to allow dataManager.syncFromServer to run
                setTimeout(() => runDiagnostics(), 800);
            });
        })();
    </script>
</body>
</html>
